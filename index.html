<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pick Queue (Phase 1)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7f9; color:#111; }
    header { position: sticky; top:0; background:#fff; border-bottom:1px solid #e6e6e6; padding:12px 14px; display:flex; gap:10px; align-items:center; z-index: 1000; }

    header h1 { font-size:16px; margin:0; font-weight:700; }
    .grow { flex:1; }
    .btn { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .45; cursor: not-allowed; }
    .muted { color:#666; font-size:12px; }
    .tabs {
      display:flex;
      gap:0;
      padding:0 14px;
      background:#fff;
      border-bottom:1px solid #e6e6e6;
    }
    .tab {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 10px;
      border:0;
      border-bottom:3px solid transparent;
      border-radius:0;
      background:transparent;
      cursor:pointer;
      font-weight:800;
      color:#667085;
    }
    .tab.active {
      color: var(--wa-green, #128C7E);
      border-bottom-color: var(--wa-green, #128C7E);
      background:transparent;
    }
    
    /* Badges + loading spinner */
    .badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:18px; padding:0 6px;
      border-radius:999px; font-size:12px; font-weight:800; background:#f1f2f4; color:#111; border:1px solid #e1e3e6; margin-left:8px; }
    .tab.active .badge { background:rgba(255,255,255,.18); color:#fff; border-color:rgba(255,255,255,.25); }

    .spinner { width:14px; height:14px; margin-left:8px; border-radius:999px; border:2px solid rgba(0,0,0,.15); border-top-color: rgba(0,0,0,.55);
      display:none; animation: spin 0.8s linear infinite; }
    .btn.loading .spinner { display:inline-block; }
    .btn.loading { opacity:.75; cursor:progress; }
    @keyframes spin { to { transform: rotate(360deg); } }
.wrap { padding: 0 14px 18px; }
    .grid { display:grid; grid-template-columns:1fr; gap:10px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:12px; cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,.04); transition: box-shadow .15s ease, transform .06s ease; }
    .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .card:active { transform: translateY(1px); }
    @media (hover:none) { .card:hover { box-shadow: 0 1px 2px rgba(0,0,0,.04); } }


    /* Card status accents */
    .card { position: relative; overflow: hidden; }
    .card::before {
      content:"";
      position:absolute; left:0; top:0; bottom:0;
      width:4px;
      background:#d1d5db;
    }
    .card[data-status="open"]::before { background:#2563eb; }
    .card[data-status="closed"]::before { background:#16a34a; }
    .card[data-status="delivered"]::before { background:#16a34a; }
    .card[data-status="pickedup"]::before { background:#16a34a; }
    .card[data-status="cancelled"]::before { background:#dc2626; }

    .card[data-status="cancelled"]{ background:#fff7f7; border-color:#ffd6d6; }
    .card[data-status="closed"],
    .card[data-status="delivered"],
    .card[data-status="pickedup"]{ background:#f6fffa; border-color:#c9f3da; }

    /* Slightly tighter typography on mobile */
    @media (max-width: 520px){
      .card { padding: 10px; border-radius: 14px; }
      .ordno { font-size: 14px; }
      .total { font-size: 14px; }
      .name { font-size: 13px; }
      .cardDt { white-space:nowrap; color:#666; font-size:12px; }
      .pills { gap:6px; }
      .pill { font-size: 11px; padding:3px 7px; }
    }
    .topline { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }

    /* Card header layout (Option D compact) */
    .cardHead { display:flex; flex-direction:column; gap:6px; }
    .cardRow1 { display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .cardRow2 { display:flex; align-items:baseline; gap:8px; justify-content:flex-start; flex-wrap:wrap; }
    .cardDt { white-space:nowrap; }
    @media (max-width: 480px) {
      .cardRow2 { gap:8px; }
      .cardDt { font-size:11px; }
    }
    .ordno { font-weight:900; }
    .name { font-weight:700; margin-top:4px; }
    .total { font-weight:900; }
    .pills { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .pill { font-size:12px; border:1px solid #ddd; padding:4px 8px; border-radius:999px; background:#fafafa; }
    .pill.ok { border-color:#bfe6c6; background:#f1fbf3; }
    .pill.warn { border-color:#ffe2a8; background:#fff8e8; }
    .pill.bad { border-color:#ffb5b5; background:#fff0f0; }

    
    /* WA pill icons */
    .pill.wa { display:inline-flex; align-items:center; gap:6px; }
    .pill.wa .ico { width:14px; height:14px; display:inline-block; }
    .pill.wa.ok { border-color:#bfe6c6; background:#f1fbf3; }
    .pill.wa.warn { border-color:#ffe2a8; background:#fff8e8; }
    .pill.wa svg { fill: currentColor; }
/* Modal */
    .modalBackdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:flex-end; }
    .modalBackdrop.show { display:flex; }
    .sheet { width:100%; max-width:780px; margin: 0 auto; background:#fff; border-radius:18px 18px 0 0; padding:14px; max-height: 88vh; overflow:auto; }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .sheet h2 { margin:0; font-size:16px; }
    .close { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800; }
    .sec { margin-top:12px; border-top:1px solid #eee; padding-top:12px; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 12px; font-size:13px; }
    .kv div { padding:2px 0; }
    .items { display:flex; flex-direction:column; gap:10px; }
    .item { display:flex; gap:10px; border:1px solid #eee; border-radius:12px; padding:10px; }

    .pickCb { width:18px; height:18px; margin-top:4px; }
    .pickCol { display:flex; align-items:flex-start; }

    .thumb { width:54px; height:54px; border-radius:10px; background:#f1f1f1; object-fit:cover; flex: 0 0 54px; }
    .itName { font-weight:800; }
    .itOpt { font-size:12px; color:#666; margin-top:2px; }
    .itQty { font-weight:900; margin-right:6px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .input { padding:8px 10px; border:1px solid #ddd; border-radius:10px; width: 420px; max-width: 52vw; }
    .statusDot { width:10px; height:10px; border-radius:999px; background:#bbb; display:inline-block; margin-right:8px; }
    .okDot { background:#2ecc71; }
    .badDot { background:#e74c3c; }


/* --- Mobile optimization (CSS-only) --- */
@media (max-width: 640px) {
  header { flex-wrap: wrap; gap: 8px; padding: 10px 12px; }
  header h1 { font-size: 14px; }

  /* Put search on its own line, full width */
  #searchBox { width: 100% !important; max-width: none !important; flex: 1 1 100%; order: 3; }

  /* Build info becomes smaller and wraps */
  #buildInfo { flex: 1 1 100%; order: 4; font-size: 11px; }

  /* Buttons a bit smaller */
  .btn { padding: 7px 9px; border-radius: 12px; font-size: 12px; }
  .close { padding: 7px 9px; border-radius: 12px; font-size: 12px; }

  .tabs { padding: 10px 12px; gap: 8px; }
  .tab { padding: 8px 12px; font-size: 13px; }

  .wrap { padding: 0 12px 16px; }
  .grid { gap: 10px; }

  /* Cards: stack price/date under the name */
  .card { padding: 10px; border-radius: 16px; }
  .topline { flex-direction: column; align-items: flex-start; }
  .total { margin-top: 6px; }

  .pills { gap: 6px; }
  .pill { font-size: 11px; padding: 4px 8px; }

  /* Modals / bottom sheet: use more of the screen */
  .modalBackdrop { align-items: stretch; }
  .sheet { max-height: 92vh; padding: 12px; border-radius: 16px 16px 0 0; }

  /* Key/value table: narrower label column */
  .kv { grid-template-columns: 92px 1fr; font-size: 12px; }

  /* Inputs full width */
  .input { width: 100%; max-width: none; }

  /* Items: reduce thumbnail, allow long names to wrap */
  .item { padding: 8px; gap: 8px; }
  .thumb { width: 44px; height: 44px; border-radius: 10px; }
  .itName { font-size: 13px; word-break: break-word; }
  .itOpt { font-size: 11px; }
  .pickCb { width: 20px; height: 20px; margin-top: 2px; }
}


    /* --- Mobile compact card layout (Option D) --- */
    @media (max-width: 520px) {
      header { padding: 10px 12px; gap: 8px; }
      .tabs { padding: 10px 12px; gap: 6px; }
      .wrap { padding: 0 12px 14px; }

      .card { padding: 10px; border-radius: 14px; }
      .topline { display: flex; flex-direction: column; gap: 6px; }

      /* Line 1: Order + Customer in one compact line */
      .leftCol { line-height: 1.2; }
      .leftCol .ordno { display: inline; font-size: 14px; }
      .leftCol .name { display: inline; font-size: 14px; margin-top: 0; font-weight: 700; }
      .leftCol .name:before { content: "  "; }

      /* Line 2: Amount + Date on one line */
      .rightCol { display: flex; gap: 10px; align-items: baseline; justify-content: space-between; }
      .rightCol .total { font-size: 14px; font-weight: 900; }
      .rightCol .muted { font-size: 12px; }

      /* Pills become compact badges */
      .pills { margin-top: 8px; gap: 6px; }
      .pill { font-size: 11px; padding: 3px 7px; border-radius: 999px; }
    }


    /* --- Step 5: Mobile polish (CSS-only) --- */
    /* Safer layering: modals must always sit above cards on mobile */
    .modalBackdrop { z-index: 1000; }
    .sheet { padding-bottom: max(14px, env(safe-area-inset-bottom)); }

    /* Better tap feedback */
    .card:active { transform: translateY(1px); }

    /* Mobile-first refinements */
    @media (max-width: 520px) {
      body { background:#f4f6f8; }
      header {
        padding: 10px 12px;
        gap: 8px;
      }
      header h1 { font-size: 18px; }
      /* Make right side less cramped */
      #buildInfo { font-size: 11px; line-height: 1.2; }

      .btn {
        padding: 9px 12px;
        border-radius: 12px;
      }

      .tabs { padding: 10px 12px; gap: 10px; }
      .tab { padding: 10px 14px; border-radius: 14px 14px 0 0; }

      .wrap { padding: 0 12px 18px; }
      .grid { gap: 12px; }

      .card {
        border-radius: 18px;
        padding: 12px;
        border-color: rgba(0,0,0,.08);
        box-shadow: 0 1px 0 rgba(0,0,0,.04), 0 10px 24px rgba(0,0,0,.05);
      }

      /* Keep the top line readable */
      .ordno { font-size: 20px; letter-spacing: .2px; }
      .total { font-size: 20px; }
      .name { font-size: 18px; line-height: 1.15; }

      /* Prevent long names from breaking layout */
      .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      /* If you prefer 2 lines instead, swap to:
         .name { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; white-space:normal; }
      */

      .pills { gap: 6px; margin-top: 10px; }
      .pill { padding: 6px 10px; font-size: 12px; }

      /* Reduce visual noise for hint/debug line */
      #hint { font-size: 12px; color: #7a7a7a; }
    }


/* --- Visual polish (v7.1) --- */
:root{
  --bg: #f6f7f9;
  --card: #ffffff;
  --text: #111;
  --muted: #667085;
  --border: #e6e6e6;
  --shadow: 0 6px 18px rgba(16,24,40,.08);
  --shadow2: 0 2px 8px rgba(16,24,40,.06);

  --c-open: #2563eb;        /* blue */
  --c-closed: #16a34a;      /* green */
  --c-cancelled: #dc2626;   /* red */
}

body{
  background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.10), transparent 55%),
              radial-gradient(1000px 520px at 95% 0%, rgba(22,163,74,.10), transparent 55%),
              var(--bg);
  color: var(--text);
}

.muted{ color: var(--muted); }

header{
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(8px);
}

.card{
  background: var(--card);
  box-shadow: var(--shadow2);
  border-color: rgba(15,23,42,.10);
  position: relative;
  overflow: hidden;
}

.card:active{ transform: translateY(1px); }

.card::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:4px;
  background: rgba(2,6,23,.18);
}

.card[data-status="open"]::before{ background: var(--c-open); }
.card[data-status="closed"]::before{ background: var(--c-closed); }
.card[data-status="cancelled"]::before{ background: var(--c-cancelled); }

.cardHead{ padding-left: 6px; } /* small visual alignment with status bar */

.total{
  letter-spacing: .2px;
}

/* Pills slightly more modern */
.pill{
  border-color: rgba(15,23,42,.10);
  background: rgba(2,6,23,.02);
}
.pill.ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); }
.pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
.pill.bad{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); }

/* Tabs: small color cue */
.tab.active{
  box-shadow: 0 6px 14px rgba(17,24,39,.18);
}


/* === WhatsApp vibe header + tabs (CSS-only) === */
:root{
  --wa-green:#075E54;
  --wa-green2:#128C7E;
  --wa-mint:#DCF8C6;
  --wa-surface:#F0FDF4;
}
header{
  background: linear-gradient(90deg, var(--wa-green), var(--wa-green2));
  border-bottom: 0;
  box-shadow: 0 6px 18px rgba(0,0,0,.10);
  color:#fff;
}
header h1{ color:#fff; }
header .muted{ color: rgba(255,255,255,.85); }
header .btn{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.28);
  color:#fff;
}
header .btn:hover{ background: rgba(255,255,255,.18); }
header .btn:active{ transform: translateY(1px); }

header .input{
  background: rgba(255,255,255,.16);
  border-color: rgba(255,255,255,.28);
  color:#fff;
}
header .input::placeholder{ color: rgba(255,255,255,.72); }

/* Tabs look more "app-like" */
.tabs{
  background: var(--wa-surface);
  border-bottom: 1px solid rgba(7,94,84,.10);
  padding-top: 10px;
  padding-bottom: 10px;
}
.tab{
  border-color: rgba(7,94,84,.20);
  background:#fff;
  color: var(--wa-green);
}
.tab .badge{
  background: rgba(7,94,84,.10);
  color: var(--wa-green);
  border-color: rgba(7,94,84,.18);
}
.tab.active{
  background: var(--wa-green2);
  border-color: var(--wa-green2);
  color:#fff;
}
.tab.active .badge{
  background: rgba(255,255,255,.20);
  color:#fff;
  border-color: rgba(255,255,255,.26);
}

/* Slight mint hint behind list (subtle WhatsApp feel) */
.wrap{
  background: linear-gradient(180deg, rgba(220,248,198,.22), rgba(246,247,249,0) 140px);
}



/* ===== WhatsApp vibe cohesive theme (CSS-only) ===== */
:root{
  --wa-green:#25D366;
  --wa-green-dark:#1DA851;
  --wa-teal:#075E54;
  --wa-bg:#EAF7F1;          /* chat background */
  --wa-surface:#FFFFFF;     /* cards/sheets */
  --wa-border:#D7EBDD;
  --wa-text:#0B1F16;
  --wa-muted:#5E6C64;
  --wa-pill:#F3FAF6;
  --wa-shadow: 0 6px 18px rgba(11,31,22,.08);
  --wa-shadow-soft: 0 3px 12px rgba(11,31,22,.06);
}

/* Page */
body{
  background: var(--wa-bg);
  color: var(--wa-text);
}
.muted{ color: var(--wa-muted); }

/* Header + search */
header{
  background: linear-gradient(180deg, rgba(37,211,102,.14), rgba(37,211,102,.06) 55%, rgba(255,255,255,1));
  border-bottom: 1px solid var(--wa-border);
  box-shadow: var(--wa-shadow-soft);
}
header h1{ color: var(--wa-text); letter-spacing:.2px; }
.input{
  border-color: var(--wa-border);
  background: rgba(255,255,255,.92);
}
.input:focus{
  outline: none;
  border-color: rgba(37,211,102,.55);
  box-shadow: 0 0 0 3px rgba(37,211,102,.18);
}

/* Buttons */
.btn, .close{
  border-color: var(--wa-border);
  background: rgba(255,255,255,.92);
}
.btn:hover, .close:hover{ filter: brightness(.99); }
.btn:active, .close:active{ transform: translateY(1px); }
.btnPrimary{
  background: var(--wa-green);
  border-color: var(--wa-green);
  color: #fff;
}
.btnPrimary:hover{ background: var(--wa-green-dark); border-color: var(--wa-green-dark); }

/* Tabs */
.tabs{
  background: var(--wa-bg);
}
.tab{
  border-color: var(--wa-border);
  background: rgba(255,255,255,.82);
}
.tab.active{
  background: var(--wa-teal);
  border-color: var(--wa-teal);
  color: #fff;
  box-shadow: 0 10px 18px rgba(7,94,84,.18);
}

/* Cards */
.card{
  background: var(--wa-surface);
  border-color: var(--wa-border);
  box-shadow: var(--wa-shadow-soft);
}
.card:active{ transform: translateY(1px); }

/* Topline typography tweaks */
.ordno{ color: var(--wa-text); }
.total{ color: var(--wa-text); }

/* Pills */
.pill{
  border-color: var(--wa-border);
  background: var(--wa-pill);
  color: var(--wa-text);
}
.pill.ok{
  border-color: rgba(37,211,102,.35);
  background: rgba(37,211,102,.12);
}
.pill.warn{
  border-color: rgba(255,193,7,.40);
  background: rgba(255,193,7,.14);
}
.pill.bad{
  border-color: rgba(231,76,60,.35);
  background: rgba(231,76,60,.12);
}

/* Modal */
.modalBackdrop{
  background: rgba(6,25,18,.55);
}
.sheet{
  background: var(--wa-surface);
  border-top: 1px solid var(--wa-border);
  box-shadow: 0 -10px 22px rgba(11,31,22,.16);
}
.sec{ border-top-color: rgba(0,0,0,.06); }
.kv{ color: var(--wa-text); }
.kv .muted{ color: var(--wa-muted); }
.item{
  border-color: rgba(0,0,0,.06);
  background: rgba(255,255,255,.9);
}
.thumb{ background: rgba(0,0,0,.04); }

/* Small accent line under header area (optional visual separation) */
.wrap{ padding-top: 10px; }

/* Make checkboxes and focus states feel consistent */
.pickCb{
  accent-color: var(--wa-green);
}


/* ===== WhatsApp theme readability hotfix (override) ===== */
header{
  background: linear-gradient(90deg, #075E54, #128C7E) !important;
  color:#fff !important;
}
header h1{ color:#fff !important; }
#buildInfo{ color: rgba(255,255,255,.85) !important; }
header .muted{ color: rgba(255,255,255,.82) !important; }

/* Header buttons (Settings/Refresh) */
header .btn{
  background: rgba(255,255,255,.14) !important;
  border-color: rgba(255,255,255,.28) !important;
  color:#fff !important;
}
header .btn:hover{ background: rgba(255,255,255,.20) !important; }
header .btn[disabled]{ opacity:.55 !important; }

/* Search input: keep high contrast on dark header */
header input,
header .input,
#searchInput{
  background: rgba(255,255,255,.96) !important;
  color:#111 !important;
  border-color: rgba(0,0,0,.10) !important;
  box-shadow: 0 2px 10px rgba(0,0,0,.10) !important;
}
header input::placeholder,
header .input::placeholder,
#searchInput::placeholder{
  color:#6b7280 !important;
}

/* Tabs band should not get covered and should feel connected */
.tabs{
  background: linear-gradient(90deg, #075E54, #128C7E) !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
  position: sticky;
  top: 52px; /* keep below header */
  z-index: 40;
}
.tab{
  background: rgba(255,255,255,.14) !important;
  border-color: rgba(255,255,255,.28) !important;
  color:#fff !important;
}
.tab.active{
  background: #25D366 !important;
  border-color: #25D366 !important;
  color:#0b2b22 !important;
}


/* === WhatsApp vibe: card theme (readable) === */
:root{
  --wa-header:#075E54;
  --wa-accent:#25D366;
  --wa-accent-2:#128C7E;
  --wa-bg:#E9F5EF;
  --wa-card:#FFFFFF;
  --wa-text:#0b1b14;
  --wa-muted:rgba(11,27,20,.62);
  --wa-border:rgba(11,27,20,.10);
  --wa-shadow:0 6px 18px rgba(0,0,0,.06);
}

body{ background: var(--wa-bg); color: var(--wa-text); }
.muted{ color: var(--wa-muted); }

/* Cards */
.card{
  position:relative;
  background: var(--wa-card);
  border:1px solid var(--wa-border);
  border-radius:18px;
  box-shadow: var(--wa-shadow);
  padding:14px 14px 12px 18px; /* extra left room for accent bar */
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:6px;
  background: var(--accent, var(--wa-accent));
}
.card[data-status="open"]{ --accent: var(--wa-accent); }
.card[data-status="closed"]{ --accent: var(--wa-accent-2); }
.card[data-status="cancelled"]{ --accent: #e74c3c; }

.cardHead{ display:block; }
.cardRow1{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:12px;
}
.cardRow2{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  margin-top:6px;
}
.ordno{ letter-spacing:.2px; }
.total{ font-weight:900; }
.cardDt{ font-variant-numeric: tabular-nums; }

.pills{ margin-top:10px; gap:8px; }
.pill{
  border-color: rgba(11,27,20,.12);
  background: rgba(255,255,255,.65);
}
.pill.ok{
  border-color: rgba(37,211,102,.35);
  background: rgba(37,211,102,.12);
}
.pill.warn{
  border-color: rgba(255,194,66,.45);
  background: rgba(255,194,66,.14);
}
.pill.bad{
  border-color: rgba(231,76,60,.40);
  background: rgba(231,76,60,.12);
}

/* Touch feedback */
.card:active{ transform: translateY(1px); }

/* Mobile tuning */
@media (max-width: 520px){
  .wrap{ padding-left:12px; padding-right:12px; }
  .card{ padding:12px 12px 10px 16px; border-radius:16px; }
  .card::before{ width:5px; }
  .pills{ margin-top:8px; }
  .pill{ font-size:12px; padding:5px 10px; }
}

  /* =========================================================
     A) Accent kleuren consistent met WhatsApp theme
     B) Pills/chips consistent + betere leesbaarheid
     C) Card polish: spacing + tap feedback
     (Overrides placed at end so they win over earlier CSS)
  ========================================================== */

  :root{
    /* WhatsApp-ish status accents */
    --c-open: #25D366;      /* WhatsApp green */
    --c-closed: #128C7E;    /* WhatsApp teal */
    --c-delivered: #128C7E;
    --c-pickedup: #0f766e;
    --c-cancelled: #ef4444;
    --c-unknown: #94a3b8;
  }

  /* A) status -> accent kleur (bar + subtiele tint) */
  .card{ 
    background: #fff;
    border: 1px solid rgba(15, 23, 42, .10);
    box-shadow: 0 10px 24px rgba(2, 6, 23, .06);
    transition: transform .08s ease, box-shadow .12s ease;
  }
  .card:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(2, 6, 23, .08); }
  .card::before{ width: 6px; border-radius: 14px 0 0 14px; }

  .card[data-status="open"]{ --accent: var(--c-open); }
  .card[data-status=""]{ --accent: var(--c-open); }
  .card[data-status="closed"]{ --accent: var(--c-closed); }
  .card[data-status="delivered"]{ --accent: var(--c-delivered); }
  .card[data-status="pickedup"]{ --accent: var(--c-pickedup); }
  .card[data-status="cancelled"]{ --accent: var(--c-cancelled); }
  .card[data-status]:not([data-status="open"]):not([data-status=""]):not([data-status="closed"]):not([data-status="delivered"]):not([data-status="pickedup"]):not([data-status="cancelled"]) {
    --accent: var(--c-unknown);
  }

  /* subtiele accent glow, maar leesbaar houden */
  .card{ position: relative; overflow: hidden; }
  .card::after{
    content:"";
    position:absolute;
    inset: 0;
    background: radial-gradient(900px 180px at -10% 0%, color-mix(in srgb, var(--accent) 14%, transparent) 0%, transparent 55%);
    pointer-events:none;
  }

  /* C) Layout: netter gebruik van ruimte */
  .topline{ align-items: flex-start; }
  .ordno{ font-size: 22px; font-weight: 800; letter-spacing: .15px; }
  .name{ font-size: 24px; font-weight: 900; line-height: 1.12; }
  .total{ font-size: 24px; font-weight: 900; }
  .muted{ color: rgba(255,255,255,.85); }
  /* Maar binnen kaarten willen we donker muted */
  .card .muted{ color: rgba(15,23,42,.55); }

  /* B) Pills: whatsapp-like chips, consistent spacing */
  .pills{ gap:10px; }
  .pill{
    padding: 8px 12px;
    border-radius: 999px;
    border-color: rgba(15,23,42,.12);
    background: rgba(248,250,252,.9);
    font-weight: 700;
  }
  .pill.ok{ border-color: color-mix(in srgb, var(--c-open) 32%, rgba(15,23,42,.12)); background: color-mix(in srgb, var(--c-open) 12%, #fff); }
  .pill.warn{ border-color: color-mix(in srgb, #f59e0b 34%, rgba(15,23,42,.12)); background: color-mix(in srgb, #f59e0b 12%, #fff); }
  .pill.bad{ border-color: color-mix(in srgb, var(--c-cancelled) 34%, rgba(15,23,42,.12)); background: color-mix(in srgb, var(--c-cancelled) 10%, #fff); }

  /* Mobile: iets compacter, betere tik targets */
  @media (max-width: 520px){
    .card{ padding: 14px; }
    .ordno{ font-size: 26px; }
    .name{ font-size: 22px; }
    .total{ font-size: 26px; }
    .pill{ padding: 8px 12px; }
  }

  /* =========================================================
     A) Accent kleuren consistent met WhatsApp theme
     B) Pills/chips consistent + betere leesbaarheid
     C) Card polish: spacing + tap feedback
     (Overrides placed at end so they win over earlier CSS)
  ========================================================= */

  :root{
    /* WhatsApp-ish accents */
    --wa-green:#128C7E;
    --wa-green-2:#25D366;
    --wa-bg:#e6f6ef;
    --wa-card:#ffffff;
    --wa-line:#d7efe6;
    --wa-text:#0b1f1b;
    --wa-muted:#5a6b65;

    /* Status accents */
    --st-open: var(--wa-green-2);
    --st-closed: var(--wa-green);
    --st-delivered: var(--wa-green);
    --st-cancelled:#ef4444;
    --st-unknown:#94a3b8;
  }

  body{ background: var(--wa-bg); color: var(--wa-text); }

  /* Card container spacing on mobile */
  .wrap{ padding: 0 14px 18px; }

  /* A) Card accent bar uses theme colors */
  .card{
    background: var(--wa-card);
    border-color: rgba(18,140,126,.18);
    box-shadow: 0 10px 24px rgba(16,24,40,.08);
  }
  .card::before{ background: var(--st-unknown); }
  .card[data-status="open"]::before{ background: var(--st-open); }
  .card[data-status="closed"]::before,
  .card[data-status="delivered"]::before,
  .card[data-status="pickedup"]::before{ background: var(--st-closed); }
  .card[data-status="cancelled"]::before{ background: var(--st-cancelled); }

  /* subtle tinted edge to tie accent into card */
  .card[data-status="open"]{ box-shadow: 0 10px 24px rgba(37,211,102,.10); }
  .card[data-status="cancelled"]{ box-shadow: 0 10px 24px rgba(239,68,68,.10); }

  /* C) Tap feedback */
  .card{ transition: transform .06s ease, box-shadow .12s ease; }
  .card:active{ transform: translateY(1px) scale(.995); }

  /* C) Make the top rows feel tighter and more "chat"-like */
  .ordno{ letter-spacing: .2px; }
  .total{ letter-spacing: .2px; }
  .createdAt{ color: var(--wa-muted); }
  .name{ color: var(--wa-text); }

  /* B) Pills/chips: unified radius + borders + status colors */
  .pill{
    border-color: rgba(18,140,126,.18);
    background: rgba(18,140,126,.06);
    color: var(--wa-text);
  }
  .pill.ok{ border-color: rgba(37,211,102,.28); background: rgba(37,211,102,.12); }
  .pill.warn{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.10); }
  .pill.bad{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); }

  /* Status pill driven by data-status for consistency */
  .card[data-status="open"] .pill.status{ border-color: rgba(37,211,102,.30); background: rgba(37,211,102,.12); }
  .card[data-status="closed"] .pill.status,
  .card[data-status="delivered"] .pill.status,
  .card[data-status="pickedup"] .pill.status{ border-color: rgba(18,140,126,.30); background: rgba(18,140,126,.10); }
  .card[data-status="cancelled"] .pill.status{ border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); }

  /* Slightly smaller pills on mobile to reduce wrapping */
  @media (max-width: 520px){
    .pill{ font-size:12px; padding:6px 10px; }
    .pills{ gap:8px; }
  }

  /* Ensure header/tabs remain above cards while scrolling */
  header{ z-index: 50; }
  .tabs{ z-index: 49; }

  </style>
</head>
<body>
  <header>
    <h1>Pick Queue</h1>
    <div class="grow"></div>
    <input class="input" id="searchBox" placeholder="Zoek order of klantâ€¦" style="width:240px;max-width:46vw;" />
    <span class="muted" id="buildInfo">not connected</span>
    <button class="btn" id="btnSettings">Settings</button>
    <button class="btn" id="btnRefresh"><span class="btnLabel">Refresh</span><span class="spinner" aria-hidden="true"></span></button>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="open" id="tabOpen">Open orders<span class="badge" id="badgeOpen">0</span></button>
    <button class="tab" data-tab="closed" id="tabClosed">Afgehandeld<span class="badge" id="badgeClosed">0</span></button>
  </div>

  <div class="wrap">
    <div class="muted" id="hint"></div>
    <div class="muted" id="debugInfo" style="margin-top:4px;"></div>
    <div class="grid" id="list"></div>
  </div>

  <!-- Settings Modal -->
  <div class="modalBackdrop" id="settingsModal">
    <div class="sheet">
      <div class="row">
        <h2>Settings</h2>
        <button class="close" id="closeSettings">Close</button>
      </div>
      <div class="sec">
        <div class="kv">
          <div class="muted">API URL</div>
          <div>
            <input class="input" id="apiBase" placeholder="https://script.google.com/macros/s/.../exec" />
            <div class="muted" style="margin-top:6px;">Tip: plak de Web App /exec URL hier.</div>
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn" id="btnTestPing">Test ping</button>
          <button class="btn" id="btnSaveApi">Save</button>
        </div>
        <div class="muted" id="pingResult" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modalBackdrop" id="orderModal">
    <div class="sheet">
      <div class="row">
        <h2 id="odTitle">Order</h2>
        <button class="close" id="closeOrder">Close</button>
      </div>

      <div class="sec">
        <div class="kv" id="odKV"></div>
      </div>

      <div class="sec">
        <div class="row" style="margin-bottom:10px;">
          <strong>WhatsApp</strong>
          <span class="muted" id="waStatusText">â€”</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnWhatsApp" disabled>WhatsApp klant</button>
          <button class="btn" id="btnToggleWA">Toggle WA sent</button>
        </div>

        <div class="muted" id="waPrep" style="display:none;margin-top:8px;">Bericht: â€”</div>

        <div class="muted" id="waResult" style="margin-top:10px;"></div>
      </div>


      <div class="sec">
        <div class="row" style="margin-bottom:10px;">
          <strong>Items</strong>
          <span class="muted" id="odItemsCount"></span>
          <span class="muted" id="odPickStatus"></span>
        </div>
        <div class="items" id="odItems"></div>
      </div>

      <div class="sec" id="odActionsSec">
        <div class="row" style="margin-bottom:10px;">
          <strong>Afhandeling</strong>
          <span class="muted" id="odStatusHint">â€”</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnMarkDone" disabled>Afgehandeld</button>
          <button class="btn" id="btnCancel">Cancel</button>
        </div>

        <div id="cancelBox" style="display:none; margin-top:10px;">
          <div class="muted" style="margin-bottom:6px;">Reden (verplicht bij cancel)</div>
          <textarea id="cancelNote" rows="3" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,.15); border-radius:12px;"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
            <button class="btn" id="btnConfirmCancel">Bevestig Cancel</button>
            <button class="btn" id="btnCancelBack">Terug</button>
          </div>
        </div>

        <div class="muted" id="odActionResult" style="margin-top:10px;"></div>
      </div>

    </div>
  </div>

<script>
  // --- Basic state ---
  const LS_KEY = "pq_api_base_v1";
  const DEBUG = /(?:\?|&)debug=1(?:&|$)/.test(location.search);

  let currentTab = "open";
  let lastOrders = [];

  const tabCountCache = { open: null, closed: null };

  async function refreshTabCount_(tab) {
    try {
      const action = tab === "open" ? "getOpenOrders" : "getClosedOrders";
      const res = await api(action);
      if (!res || !res.ok) return;
      const count = Array.isArray(res.orders) ? res.orders.length : 0;
      tabCountCache[tab] = count;
      updateTabBadge_(tab, count);
    } catch (e) {
      // ignore
    }
  }
  let searchQuery = "";

  function getApiBase() {
    return (localStorage.getItem(LS_KEY) || "").trim();
  }
  function normalizeApiBase_(v) {
    const raw = (v || "").trim();
    if (!raw) return "";
    try {
      const u = new URL(raw);
      u.search = "";
      u.hash = "";
      return u.toString();
    } catch (e) {
      // If it's not a valid URL, keep as-is (will error later in api())
      return raw;
    }
  }

  function setApiBase(v) {
    localStorage.setItem(LS_KEY, normalizeApiBase_(v));
  }

  // --- JSONP helper ---
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + cbName + "&_=" + Date.now();
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };
      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };
      function cleanup() {
        try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }
      document.body.appendChild(script);
    });
  }

  function api(action, params={}) {
    const base = getApiBase();
    if (!base) return Promise.reject(new Error("Missing API base URL. Open Settings."));
    const u = new URL(base);

    // IMPORTANT: make sure we don't accidentally reuse old query params
    // (e.g. a saved URL like .../exec?action=...&status=Cancelled)
    u.search = "";
    u.hash = "";

    u.searchParams.set("action", action);
    for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
    return jsonp(u.toString());
  }

  // --- UI render ---
  function pill(text, kind) {
    const span = document.createElement("span");
    span.className = "pill " + (kind || "");
    span.textContent = text;
    return span;
  }
  function createWAPill_(sent) {
    const span = document.createElement("span");
    span.className = "pill wa " + (sent ? "ok" : "warn");
    // Inline SVG icons to avoid external deps
    const ico = sent
      ? '<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M9.2 16.2 4.9 11.9l1.4-1.4 2.9 2.9 8.6-8.6 1.4 1.4z"></path></svg>'
      : '<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"></path></svg>';
    span.innerHTML = ico + "<span>WA</span>";
    span.title = sent ? "WhatsApp: Sent" : "WhatsApp: Not sent";
    return span;
  }


  function renderList(orders) {
    const list = document.getElementById("list");
    list.innerHTML = "";

    if (!orders.length) {
      document.getElementById("hint").textContent = (currentTab === "open")
        ? "ðŸ“­ Geen open orders. Gebruik de zoekbalk om een order te vinden."
        : "âœ… Geen afgehandelde orders in deze periode.";
      return;
    }
    document.getElementById("hint").textContent = "";

    orders.forEach(o => {
      const card = document.createElement("div");
      card.className = "card";
      // status key used for CSS accents
      const stKey = String(o.OrderStatus || "Open").trim().toLowerCase();
      const statusKey = (stKey === "cancelled") ? "cancelled" : ((stKey === "" || stKey === "open") ? "open" : "closed");
      card.dataset.status = statusKey;
      card.onclick = () => openOrder(o.OrderNumber);

      const head = document.createElement("div");
      head.className = "cardHead";

      const createdDisp = formatDateDisplay_(o.CreatedAt || "");

      head.innerHTML = `
        <div class="cardRow1">
          <div class="ordno">${escapeHtml(o.OrderNumber || "")}</div>
          <div class="total">${formatSRD(o.OrderTotalSRD)}</div>
        </div>
        <div class="cardRow2">
          <div class="name">${escapeHtml(o.CustomerName || "")}</div>
          <div class="muted cardDt">${escapeHtml(createdDisp)}</div>
        </div>
      `;

      const pills = document.createElement("div");
      pills.className = "pills";

      // WA pill
      pills.appendChild(createWAPill_(!!o.WhatsAppSent));

      // Payment pill (phase1: minimal)
      const pay = (o.PaymentStatus || "").toString().trim();
      pills.appendChild(
        pill("Pay: " + (pay ? pay : "â€”"), pay === "Paid" ? "ok" : (pay === "Unpaid" ? "warn" : ""))
      );

      // Status pill
      const st = (o.OrderStatus || "Open").toString().trim() || "Open";
      pills.appendChild(
        pill("Status: " + st, st === "Cancelled" ? "bad" : (st === "Closed" || st === "Delivered" || st === "PickedUp" ? "ok" : ""))
      );

      card.appendChild(head);
      card.appendChild(pills);
      list.appendChild(card);
    });
  }


  function filterOrders_(orders) {
    const q = (searchQuery || "").trim().toLowerCase();
    if (!q) return orders || [];
    return (orders || []).filter(o => {
      const on = String(o.OrderNumber || "").toLowerCase();
      const cn = String(o.CustomerName || "").toLowerCase();
      return on.includes(q) || cn.includes(q);
    });
  }

  // Status buckets (Phase 1)
  const CLOSED_STATUSES = new Set(["closed","delivered","pickedup","cancelled"]);
  const OPEN_STATUSES = new Set(["open","awaiting processing","processing","ready for pickup","shipped","out for delivery"]);

  function filterByTabStatus_(orders) {
    const arr = Array.isArray(orders) ? orders : [];
    const norm = (s) => String(s || "").trim().toLowerCase();

    if (currentTab === "closed") {
      // show ALL "closed-like" statuses, case-insensitive
      return arr.filter(o => CLOSED_STATUSES.has(norm(o && o.OrderStatus)));
    }

    // open tab: anything NOT closed-like (keep new Ecwid statuses too)
    return arr.filter(o => !CLOSED_STATUSES.has(norm(o && o.OrderStatus)));
  }

  function formatSRD(v) {
    const n = Number(v || 0);
    // No thousand separators (grouping) for SRD display
    return "SRD " + n.toLocaleString("nl-NL", { maximumFractionDigits: 2, useGrouping: false });
  }

  // Display CreatedAt as Suriname local time, without timezone label
  function formatDateDisplay_(s) {
    // Returns: dd-mm-jjjj Â· hh:mm  (Suriname time, no timezone text)
    if (!s) return "";
    const raw = String(s).trim();
    if (!raw) return "";
    try {
      // ISO-like (e.g. 2026-01-30T15:45:05.000Z)
      if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) {
        const d = new Date(raw);
        const date = d.toLocaleDateString("nl-NL", { timeZone: "America/Paramaribo" });
        const time = d.toLocaleTimeString("nl-NL", { timeZone: "America/Paramaribo", hour: "2-digit", minute: "2-digit" });
        return `${date} Â· ${time}`;
      }

      // If it's already like "dd-mm-jjjj hh:mm" or "dd-mm-jjjj, hh:mm"
      const m = raw.match(/^(\d{2}-\d{2}-\d{4})[\s,]+(\d{2}:\d{2})/);
      if (m) return `${m[1]} Â· ${m[2]}`;

      // Last resort: return raw as-is
      return raw;
    } catch (e) {
      return raw;
    }
  }



  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function setDebug_(msg) {
    if (!DEBUG) { const el = document.getElementById("debugInfo"); if (el) el.textContent = ""; return; }
    const el = document.getElementById("debugInfo");
    if (el) el.textContent = msg || "";
  }

  // --- Tabs & load ---
  async function loadBuildInfo() {
    try {
      const res = await api("ping");
      if (res && res.ok) {
        document.getElementById("buildInfo").textContent = `${res.build} â€¢ ${res.time}`;
      } else {
        document.getElementById("buildInfo").textContent = "ping failed";
      }
    } catch (e) {
      document.getElementById("buildInfo").textContent = "not connected";
    }
  }

  
  function sortNewestFirst_(orders) {
    return (orders || []).slice().sort((a, b) => {
      const ta = Date.parse(a.CreatedAt || 0);
      const tb = Date.parse(b.CreatedAt || 0);
      return tb - ta; // newest first
    });
  }

async function loadOrders() {
    const action = currentTab === "open" ? "getOpenOrders" : "getClosedOrders";
    const res = await api(action);
    if (!res || !res.ok) throw new Error((res && res.error) || "API error");

    // Server already returns the right list for each tab.
    lastOrders = sortNewestFirst_(res.orders || []);
    tabCountCache[currentTab] = lastOrders.length;
    updateTabBadge_(currentTab, lastOrders.length);

    // Keep the other tab badge in sync (background)
    const otherTab = currentTab === "open" ? "closed" : "open";
    if (tabCountCache[otherTab] === null) refreshTabCount_(otherTab);
    setDebug_(`tab=${currentTab} â€¢ total=${lastOrders.length} â€¢ q="${searchQuery}"`);
    renderList(filterOrders_(lastOrders));

    prefetchTopDetails_(lastOrders);
  }

  // Switch tabs (Open / Afgehandeld)
  function setTab(tab) {
    currentTab = (tab === "closed") ? "closed" : "open";
    const openBtn = document.getElementById("tabOpen");
    const closedBtn = document.getElementById("tabClosed");
    if (openBtn) openBtn.classList.toggle("active", currentTab === "open");
    if (closedBtn) closedBtn.classList.toggle("active", currentTab === "closed");
    // keep existing list but apply filter immediately for instant feedback
    renderList(filterOrders_(lastOrders || []));
  }

  function updateTabBadge_(tab, count) {
    try {
      const t = (tab === "closed") ? "closed" : "open";
      const n = (typeof count === "number") ? count : 0;
      const el = document.getElementById(t === "open" ? "badgeOpen" : "badgeClosed");
      if (el) el.textContent = String(n);
    } catch (e) {}
  }


  // --- Order detail ---
  async function openOrder(orderNumber) {
    try {
      const modal = document.getElementById("orderModal");
      modal.classList.add("show");
document.getElementById("odTitle").textContent = "Order " + orderNumber;
      document.getElementById("odKV").innerHTML = `<div class="muted">Loading</div><div>â€¦</div>`;
      document.getElementById("odItems").innerHTML = "";
      document.getElementById("odItemsCount").textContent = "";

      // Fast path: use cached order detail if available
      const cached = getCachedOrderDetail_(orderNumber);
      if (cached) {
        const oCached = cached;
        currentOrder = oCached;
        initPickState_(currentOrder);

        // WhatsApp button starts disabled until message is prefetched
        const btnWA = document.getElementById("btnWhatsApp");
        if (btnWA) btnWA.disabled = true;
        setWAPrepText_("", false);
        setWAUI(currentOrder);
        const waResEl = document.getElementById("waResult");
        if (waResEl) waResEl.textContent = "";
        setWAPrepText_("", false);

        // Render immediately from cache
        applyOrderToModal_(oCached);
        updateOrderActionsUI_();

        // Prefetch WhatsApp message in background; enable button only when ready
        prefetchWAMsg(currentOrder.OrderNumber)
          .then(() => {
            if (currentOrder && currentOrder.OrderNumber === oCached.OrderNumber) {
              const btn = document.getElementById("btnWhatsApp");
              if (btn) btn.disabled = false;
              setWAPrepText_("", false);
            }
          })
          .catch(() => {
            if (currentOrder && currentOrder.OrderNumber === oCached.OrderNumber) {
              const btn = document.getElementById("btnWhatsApp");
              if (btn) btn.disabled = true;
              setWAPrepText_("WhatsApp bericht niet beschikbaar", true);
            }
          });

        // Refresh cache in background (won't block UI)
        prefetchOrderDetail_(orderNumber).then(fresh => {
          if (fresh && currentOrder && currentOrder.OrderNumber === fresh.OrderNumber) {
            // Update modal if still on same order
            initPickState_(fresh);
            applyOrderToModal_(fresh);
          }
        }).catch(()=>{});

        return;
      }

      const res = await api("getOrder", { orderNumber });
      if (!res || !res.ok) throw new Error((res && res.error) || "API error");

      const o = res.order || {};
      currentOrder = o;
      initPickState_(currentOrder);

      // WhatsApp button starts disabled until message is prefetched
      const btnWA = document.getElementById("btnWhatsApp");
      if (btnWA) btnWA.disabled = true;
      setWAPrepText_("", false);
      setWAUI(currentOrder);
      const waResEl = document.getElementById("waResult");
      if (waResEl) waResEl.textContent = "";
      setWAPrepText_("", false);
      // Prefetch WhatsApp message in background; enable button only when ready
      prefetchWAMsg(currentOrder.OrderNumber)
        .then(() => {
          if (currentOrder && currentOrder.OrderNumber === o.OrderNumber) {
            const btn = document.getElementById("btnWhatsApp");
            if (btn) btn.disabled = false;
            setWAPrepText_("", false);
          }
        })
        .catch(() => {
          if (currentOrder && currentOrder.OrderNumber === o.OrderNumber) {
            const btn = document.getElementById("btnWhatsApp");
            if (btn) btn.disabled = true;
            setWAPrepText_("WhatsApp bericht niet beschikbaar", true);
          }
        });
            // Cache and render
      setCachedOrderDetail_(o);
      applyOrderToModal_(o);
      updateOrderActionsUI_();

    } catch (e) {
      document.getElementById("odKV").innerHTML = `<div class="muted">Error</div><div>${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  function addKV(container, k, v) {
    const a = document.createElement("div");
    a.className = "muted";
    a.textContent = k;
    const b = document.createElement("div");
    b.textContent = (v === null || v === undefined) ? "" : String(v);
    container.appendChild(a);
    container.appendChild(b);
  }

  function formatOptions(options) {
    if (!options) return "";
    if (Array.isArray(options)) {
      return options.map(o => (o.name && o.value) ? `${o.name}: ${o.value}` : "").filter(Boolean).join(" Â· ");
    }
    // sometimes options could be object
    if (typeof options === "object") {
      return Object.entries(options).map(([k,v]) => `${k}: ${v}`).join(" Â· ");
    }
    return String(options);
  }

  function firstImageUrl(it) {
    // Phase 1: minimal; true fallback chain comes later (thumb -> image -> alt list)
    return it.thumbUrl || it.imageUrl || (Array.isArray(it.altImageUrls) ? it.altImageUrls[0] : "") || "";
  }

  // --- Modal controls ---
  const settingsModal = document.getElementById("settingsModal");
  document.getElementById("btnSettings").onclick = () => {
    document.getElementById("apiBase").value = getApiBase();
    document.getElementById("pingResult").textContent = "";
    settingsModal.classList.add("show");
  };
  document.getElementById("closeSettings").onclick = () => settingsModal.classList.remove("show");
  settingsModal.addEventListener("click", (e) => { if (e.target === settingsModal) settingsModal.classList.remove("show"); });

  document.getElementById("btnSaveApi").onclick = async () => {
    setApiBase(document.getElementById("apiBase").value);
    await loadBuildInfo();
    await safeLoadOrders();
    refreshTabCount_("open");
    refreshTabCount_("closed");
    setupWhatsAppButtons();
    settingsModal.classList.remove("show");
  };

  document.getElementById("btnTestPing").onclick = async () => {
    setApiBase(document.getElementById("apiBase").value);
    const el = document.getElementById("pingResult");
    el.textContent = "Testingâ€¦";
    try {
      const res = await api("ping");
      el.textContent = res && res.ok ? `OK: ${res.build} @ ${res.time}` : `Fail: ${(res && res.error) || "unknown"}`;
    } catch (e) {
      el.textContent = "Error: " + (e.message || String(e));
    }
  };

  const orderModal = document.getElementById("orderModal");
  document.getElementById("closeOrder").onclick = () => orderModal.classList.remove("show");
  orderModal.addEventListener("click", (e) => { if (e.target === orderModal) orderModal.classList.remove("show"); });

  // --- v1 Afhandeling actions ---
  (function wireOrderStatusButtons_(){
    const btnDone = document.getElementById("btnMarkDone");
    const btnCancel = document.getElementById("btnCancel");
    const btnConfirmCancel = document.getElementById("btnConfirmCancel");
    const btnCancelBack = document.getElementById("btnCancelBack");
    const cancelBox = document.getElementById("cancelBox");
    const cancelNote = document.getElementById("cancelNote");
    const resultEl = document.getElementById("odActionResult");

    if (btnDone) {
      btnDone.onclick = async () => {
        try {
          if (resultEl) resultEl.textContent = "";
          // Guard: only allow when pick complete
          if (!currentOrder || !currentOrder.PickComplete) {
            if (resultEl) resultEl.textContent = "âš ï¸ Pick is nog niet compleet.";
            return;
          }
          await setOrderStatus_("Closed", "");
        } catch (e) {
          if (resultEl) resultEl.textContent = "âŒ " + (e && e.message ? e.message : String(e));
        }
      };
    }

    if (btnCancel) {
      btnCancel.onclick = () => {
        if (resultEl) resultEl.textContent = "";
        if (cancelBox) cancelBox.style.display = "block";
        if (cancelNote) cancelNote.focus();
      };
    }

    if (btnCancelBack) {
      btnCancelBack.onclick = () => {
        if (resultEl) resultEl.textContent = "";
        resetCancelUI_();
      };
    }

    if (btnConfirmCancel) {
      btnConfirmCancel.onclick = async () => {
        try {
          if (resultEl) resultEl.textContent = "";
          const note = (cancelNote ? String(cancelNote.value || "").trim() : "");
          if (!note) {
            if (resultEl) resultEl.textContent = "âš ï¸ Note is verplicht bij cancel.";
            if (cancelNote) cancelNote.focus();
            return;
          }
          await setOrderStatus_("Cancelled", note);
        } catch (e) {
          if (resultEl) resultEl.textContent = "âŒ " + (e && e.message ? e.message : String(e));
        }
      };
    }
  })();


  // tabs
  document.getElementById("tabOpen").addEventListener("click", (ev) => { ev.preventDefault(); setTab("open"); safeLoadOrders(); });
  document.getElementById("tabClosed").addEventListener("click", (ev) => { ev.preventDefault(); setTab("closed"); safeLoadOrders(); });

  document.getElementById("btnRefresh").onclick = async () => { await safeLoadOrders(); refreshTabCount_("open"); refreshTabCount_("closed"); };

  async function safeLoadOrders() {
    const btn = document.getElementById("btnRefresh");
    if (btn) { btn.classList.add("loading"); btn.disabled = true; }
    try { await loadOrders(); }
    catch (e) {
      document.getElementById("hint").textContent = "Error loading orders: " + (e.message || String(e));
      document.getElementById("list").innerHTML = "";
    }
    finally {
      const btn2 = document.getElementById("btnRefresh");
      if (btn2) { btn2.classList.remove("loading"); btn2.disabled = false; }
    }
  }

  
  // --- WhatsApp state ---
  let currentOrder = null;
  const waMsgCache = new Map(); // orderNumber -> message

  // --- Pick checks state ---
  let pickChecks = []; // boolean[] aligned to currentOrder.Items
  let pickSaveTimer = null;

  function normalizePickChecks_(items, checks) {
    const n = Array.isArray(items) ? items.length : 0;
    const out = new Array(n);
    const src = Array.isArray(checks) ? checks : [];
    for (let i = 0; i < n; i++) out[i] = !!src[i];
    return out;
  }

  function initPickState_(orderObj) {
    const items = Array.isArray(orderObj && orderObj.Items) ? orderObj.Items : [];
    pickChecks = normalizePickChecks_(items, orderObj && orderObj.PickChecks);
    if (orderObj) orderObj.PickChecks = pickChecks;
    updatePickUI_();
  }

  function updatePickUI_() {
    const el = document.getElementById("odPickStatus");
    if (!el) return;
    if (!currentOrder) { el.textContent = ""; return; }
    const done = !!currentOrder.PickComplete;
    el.textContent = done ? "Pick: Complete âœ…" : "Pick: Incompleet";
    updateOrderActionsUI_();
  }

  
  // --- Order status actions (v1 quick close) ---
  function updateOrderActionsUI_() {
    const hint = document.getElementById("odStatusHint");
    const btnDone = document.getElementById("btnMarkDone");
    const btnCancel = document.getElementById("btnCancel");
    if (!hint || !btnDone || !btnCancel) return;

    if (!currentOrder) {
      hint.textContent = "â€”";
      btnDone.disabled = true;
      return;
    }

    const st = String(currentOrder.OrderStatus || "").trim() || "Open";
    const alreadyClosed = (st === "Closed" || st === "Cancelled");
    const pickComplete = !!currentOrder.PickComplete;

    hint.textContent = `Status: ${st}` + (pickComplete ? " â€¢ PickComplete âœ…" : " â€¢ PickComplete âŒ");
    btnDone.disabled = alreadyClosed || !pickComplete;
  }

  function resetCancelUI_() {
    const box = document.getElementById("cancelBox");
    if (box) box.style.display = "none";
    const note = document.getElementById("cancelNote");
    if (note) note.value = "";
  }

  async function setOrderStatus_(status, note) {
    if (!currentOrder) throw new Error("No order selected");
    const orderNumber = String(currentOrder.OrderNumber || "").trim();
    if (!orderNumber) throw new Error("Missing OrderNumber");

    const params = { orderNumber, status: String(status || "").trim() };
    if (note) params.note = String(note);

    const res = await api("setOrderStatus", params);
    if (!res || !res.ok) throw new Error((res && res.error) || "Failed to set status");

    currentOrder.OrderStatus = status;
    document.getElementById("odActionResult").textContent = `âœ… Status bijgewerkt: ${status}`;

    // Close modal + refresh lists
    setTimeout(() => {
      document.getElementById("orderModal").classList.remove("show");
      resetCancelUI_();
      loadOrders();
    }, 250);
  }


  function scheduleSavePickChecks_() {
    if (!currentOrder) return;
    clearTimeout(pickSaveTimer);
    pickSaveTimer = setTimeout(async () => {
      try {
        const res = await api("setPickChecks", {
          orderNumber: String(currentOrder.OrderNumber || "").trim(),
          checks: JSON.stringify(pickChecks)
        });
        if (!res || !res.ok) throw new Error((res && res.error) || "Failed to save pick checks");
        currentOrder.PickComplete = !!res.PickComplete;
        currentOrder.PickChecks = pickChecks;
        updatePickUI_();
        // Optional: refresh list to show updated pills/status later
        // await safeLoadOrders();
      } catch (e) {
        const kv = document.getElementById("odKV");
        // Don't break UI; show subtle error in WA result area (reuse existing spot)
        const waRes = document.getElementById("waResult");
        if (waRes) waRes.textContent = "Pick save error: " + (e.message || String(e));
      }
    }, 300);
  }
  // --- Order detail prefetch/cache ---
  const DETAIL_PREFETCH_LIMIT = 8;
  const detailCache = new Map(); // orderNumber -> orderDetailObject
  const DETAIL_CACHE_SS_KEY = "pq_detail_cache_v1";

  function loadDetailCacheFromSession_() {
    try {
      const raw = sessionStorage.getItem(DETAIL_CACHE_SS_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;
      Object.keys(obj).forEach(k => {
        if (obj[k] && typeof obj[k] === "object") detailCache.set(k, obj[k]);
      });
    } catch (e) {}
  }

  function saveDetailCacheToSession_() {
    try {
      // Keep it small: max 30 orders
      const entries = Array.from(detailCache.entries()).slice(0, 30);
      const obj = {};
      entries.forEach(([k,v]) => obj[k] = v);
      sessionStorage.setItem(DETAIL_CACHE_SS_KEY, JSON.stringify(obj));
    } catch (e) {}
  }

  function getCachedOrderDetail_(orderNumber) {
    const key = String(orderNumber || "").trim();
    if (!key) return null;
    return detailCache.get(key) || null;
  }

  function setCachedOrderDetail_(orderObj) {
    if (!orderObj) return;
    const key = String(orderObj.OrderNumber || "").trim();
    if (!key) return;
    detailCache.set(key, orderObj);
    saveDetailCacheToSession_();
  }

  async function prefetchOrderDetail_(orderNumber) {
    const key = String(orderNumber || "").trim();
    if (!key) return null;
    if (detailCache.has(key)) return detailCache.get(key);
    const res = await api("getOrder", { orderNumber: key });
    if (res && res.ok && res.order) {
      setCachedOrderDetail_(res.order);
      warmImagesForOrder_(res.order);
      return res.order;
    }
    return null;
  }

  function prefetchTopDetails_(orders) {
    try {
      if (!Array.isArray(orders) || !orders.length) return;
      const top = orders.slice(0, DETAIL_PREFETCH_LIMIT)
        .map(o => String(o.OrderNumber || "").trim())
        .filter(Boolean);

      // Fire and forget; don't await to keep UI snappy
      top.forEach(n => {
        if (detailCache.has(n)) return;
        prefetchOrderDetail_(n).catch(()=>{});
      });
    } catch (e) {}
  }

  function warmImagesForOrder_(orderObj) {
    try {
      const items = Array.isArray(orderObj && orderObj.Items) ? orderObj.Items : [];
      items.forEach(it => {
        const urls = [];
        if (it && it.thumbUrl) urls.push(it.thumbUrl);
        if (it && it.imageUrl) urls.push(it.imageUrl);
        if (it && Array.isArray(it.altImageUrls)) urls.push(...it.altImageUrls);
        // Warm only first 2 per item to avoid too many requests
        urls.filter(Boolean).slice(0,2).forEach(u => { const img = new Image(); img.src = u; });
      });
    } catch (e) {}
  }

  function applyOrderToModal_(o) {
    const kv = document.getElementById("odKV");
    kv.innerHTML = "";

    addKV(kv, "Order", o.OrderNumber);
    addKV(kv, "Naam", o.CustomerName);
    addKV(kv, "Tel", o.CustomerPhone);
    addKV(kv, "Email", o.CustomerEmail);
    addKV(kv, "Total", formatSRD(o.OrderTotalSRD));
    addKV(kv, "Status", o.OrderStatus);
    addKV(kv, "WA", o.WhatsAppSent ? "Sent" : "Not sent");
    addKV(kv, "Pick", o.PickComplete ? "Complete" : "Incompleet");

    const items = Array.isArray(o.Items) ? o.Items : [];
    // sync pickChecks with current order/items
    pickChecks = normalizePickChecks_(items, o.PickChecks);
    if (currentOrder && String(currentOrder.OrderNumber||"") === String(o.OrderNumber||"")) {
      currentOrder.PickChecks = pickChecks;
      currentOrder.PickComplete = !!o.PickComplete;
    }
    updatePickUI_();
    document.getElementById("odItemsCount").textContent = `${items.length} item(s)`;

    const itemsWrap = document.getElementById("odItems");
    itemsWrap.innerHTML = "";
    items.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "item";

      // Pick checkbox
      const pickWrap = document.createElement("div");
      pickWrap.className = "pickCol";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "pickCb";
      cb.checked = !!pickChecks[idx];
      cb.onchange = () => {
        pickChecks[idx] = !!cb.checked;
        // optimistic local complete (UI only; server remains source of truth)
        currentOrder.PickChecks = pickChecks;
        scheduleSavePickChecks_();
      };
      pickWrap.appendChild(cb);

      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = "";
      img.src = firstImageUrl(it) || "";
      img.onerror = () => { img.style.display = "none"; };

      const meta = document.createElement("div");
      const qty = Number(it.qty || 1);
      const name = it.name || "";
      meta.innerHTML = `<div class="itName"><span class="itQty">${qty}Ã—</span>${escapeHtml(name)}</div>`;

      const opts = formatOptions(it.options);
      if (opts) {
        const d = document.createElement("div");
        d.className = "itOpt";
        d.textContent = opts;
        meta.appendChild(d);
      }

      row.appendChild(pickWrap);
      row.appendChild(img);
      row.appendChild(meta);
      itemsWrap.appendChild(row);
    });

    warmImagesForOrder_(o);
  }


  function cacheGetWAMsg(orderNumber) {
    const key = String(orderNumber || "").trim();
    if (!key) return "";
    if (waMsgCache.has(key)) return waMsgCache.get(key) || "";
    try {
      const v = sessionStorage.getItem("wa_msg_" + key);
      if (v) {
        waMsgCache.set(key, v);
        return v;
      }
    } catch (e) {}
    return "";
  }

  function cacheSetWAMsg(orderNumber, msg) {
    const key = String(orderNumber || "").trim();
    if (!key) return;
    const m = String(msg || "");
    waMsgCache.set(key, m);
    try { sessionStorage.setItem("wa_msg_" + key, m); } catch (e) {}
  }

  async function fetchWAMsgFromServer(orderNumber) {
    const mres = await api("getWhatsAppMessage", { orderNumber: String(orderNumber || "").trim() });
    if (!mres || !mres.ok) throw new Error((mres && mres.error) || "Failed to build WhatsApp message");
    return String(mres.message || "");
  }

  // Optional fallback if template missing server-side (should not happen in normal flow)
  function buildWhatsAppMessageFallback(order) {
    const name = order.CustomerName || "klant";
    const orderNo = order.OrderNumber || "";
    const total = formatSRD(order.OrderTotalSRD || 0);
    return `Hi ${name}, we hebben je bestelling ${orderNo} ontvangen. Dank je wel! ðŸ™\nTotaal: ${total}\nTot straks ðŸ¤`;
  }

  function prefetchWAMsg(orderNumber) {
    const key = String(orderNumber || "").trim();
    if (!key) return Promise.resolve("");
    const cached = cacheGetWAMsg(key);
    if (cached) return Promise.resolve(cached);

    return fetchWAMsgFromServer(key).then(msg => {
      cacheSetWAMsg(key, msg);
      return msg;
    });
  }

  async function markWhatsAppSent(orderNumber, sent) {
    const res = await api("setWhatsAppSent", { orderNumber, sent: sent ? "true" : "false" });
    if (!res || !res.ok) throw new Error((res && res.error) || "Failed to update WhatsApp status");
  }

  function setWAUI(order) {
    const el = document.getElementById("waStatusText");
    if (!el) return;
    if (!order) { el.textContent = "â€”"; return; }
    el.textContent = order.WhatsAppSent ? "Sent âœ…" : "Not sent âš ï¸";
  }


  function setWAPrepText_(t, isError) {
    const el = document.getElementById("waPrep");
    if (!el) return;
    if (isError) {
      el.style.display = "block";
      el.textContent = String(t || "WhatsApp bericht niet beschikbaar");
    } else {
      el.style.display = "none";
      el.textContent = "";
    }
  }

  function setupWhatsAppButtons() {
    const btnWA = document.getElementById("btnWhatsApp");
    const btnToggle = document.getElementById("btnToggleWA");
    const result = document.getElementById("waResult");
    const prep = document.getElementById("waPrep");
    const setPrep = (t) => { if (prep) prep.textContent = "Bericht: " + t; };
    if (!btnWA || !btnToggle || !result) return;

    btnWA.onclick = async () => {
      if (!currentOrder) return;

      const phoneRaw = (currentOrder.CustomerPhone || "").replace(/\D/g, "");
      if (!phoneRaw) {
        result.textContent = "Geen geldig telefoonnummer.";
        return;
      }

      try {
        // 1) use cached message if available (fast path)
        let msg = cacheGetWAMsg(currentOrder.OrderNumber);
        if (msg) setWAPrepText_("", false);

        // 2) if not cached, fetch now (slow path)
        if (!msg) {
          setWAPrepText_("", false);
          result.textContent = "Bericht ladenâ€¦";
          msg = await fetchWAMsgFromServer(currentOrder.OrderNumber);
          cacheSetWAMsg(currentOrder.OrderNumber, msg);
          setWAPrepText_("", false);
        }

        // 3) open WhatsApp immediately
        const url = `https://wa.me/${phoneRaw}?text=${encodeURIComponent(msg)}`;
        window.open(url, "_blank");

        // 4) mark as sent in sheet (post-action)
        result.textContent = "Opslaanâ€¦";
        await markWhatsAppSent(currentOrder.OrderNumber, true);
        currentOrder.WhatsAppSent = true;
        setWAUI(currentOrder);
        await safeLoadOrders(); // refresh pills
        result.textContent = "WhatsApp gemarkeerd als verzonden.";
      } catch (e) {
        // last resort fallback message if server/template fails
        setWAPrepText_("WhatsApp bericht niet beschikbaar", true);
        try {
          const fallback = buildWhatsAppMessageFallback(currentOrder);
          const url = `https://wa.me/${phoneRaw}?text=${encodeURIComponent(fallback)}`;
          window.open(url, "_blank");
        } catch (_) {}
        result.textContent = "Fout: " + (e.message || String(e));
      }
    };

    btnToggle.onclick = async () => {
      if (!currentOrder) return;
      const newVal = !currentOrder.WhatsAppSent;

      try {
        result.textContent = "Opslaanâ€¦";
        await markWhatsAppSent(currentOrder.OrderNumber, newVal);
        currentOrder.WhatsAppSent = newVal;
        setWAUI(currentOrder);
        await safeLoadOrders();
    refreshTabCount_("open");
    refreshTabCount_("closed");
        result.textContent = `WhatsApp status gewijzigd (${newVal ? "Sent" : "Not sent"})`;
      } catch (e) {
        result.textContent = "Fout: " + (e.message || String(e));
      }
    };
  }

  // bootstrap
  (async function init() {
    loadDetailCacheFromSession_();
    const sb = document.getElementById("searchBox");
    if (sb) {
      sb.addEventListener("input", () => {
        searchQuery = sb.value || "";
        renderList(filterOrders_(lastOrders));
      });
    }
    await loadBuildInfo();
    await safeLoadOrders();
    refreshTabCount_("open");
    refreshTabCount_("closed");
    setupWhatsAppButtons();
    if (!getApiBase()) {
      document.getElementById("hint").textContent = "Open Settings en plak je Apps Script /exec URL.";
    }
  })();
</script>
</body>
</html>
